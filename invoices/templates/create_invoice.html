{% extends 'common/base.html'%}
{% load static %}
{% block main %}

<div class="container my-4">
  <h3>Create Invoice / Quotation</h3>
  <form method="post" id="documentForm" target="_blank">
    {% csrf_token %}

    <!-- Document Type -->
    <div class="mb-3">
      <label class="form-label">Document Type</label>
      <select name="document_type" id="document_type" class="form-select">
        <option value="invoice">Invoice</option>
        <option value="quotation">Quotation</option>
      </select>
    </div>

    <!-- Existing Customer -->
    <div class="mb-3">
      <label for="client" class="form-label">Select Existing Customer</label>
      <select name="client" id="client" class="form-select">
        <option value="">-- Select Customer --</option>
        {% for c in clients %}
        <option value="{{ c.id }}">{{ c.name }} - {{ c.email }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- OR Add New Customer -->
    <div class="border p-3 mb-4 rounded">
      <h5>Add New Customer (optional)</h5>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Name</label>
          <input type="text" name="new_client_name" class="form-control" placeholder="Customer Name">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Email</label>
          <input type="email" name="new_client_email" class="form-control" placeholder="Email">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Phone</label>
          <input type="text" name="new_client_phone" class="form-control" placeholder="Phone">
        </div>
        <div class="col-md-6 mb-3">
          <label class="form-label">Address</label>
          <textarea name="new_client_address" class="form-control" placeholder="Address"></textarea>
        </div>
      </div>
    </div>

    <!-- Invoice/Quotation Info -->
    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">Number</label>
        <input type="text" name="document_number" class="form-control" placeholder="Invoice / Quotation Number">
      </div>
      <div class="col-md-4">
        <label class="form-label">Date</label>
        <input type="date" name="date" class="form-control">
      </div>
      <div class="col-md-4">
        <label class="form-label">Due Date</label>
        <input type="date" name="due_date" class="form-control">
      </div>
    </div>

    <!-- Terms & Notes -->
    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Terms</label>
        <textarea name="terms" class="form-control" rows="2"></textarea>
      </div>
      <div class="col-md-6">
        <label class="form-label">Notes</label>
        <textarea name="notes" class="form-control" rows="2"></textarea>
      </div>
    </div>

    <!-- Items Table -->
    <h5>Items</h5>
    <table class="table table-bordered" id="itemsTable">
      <thead>
        <tr>
          <th>Description</th>
          <th style="width:100px;">Qty</th>
          <th style="width:150px;">Unit Price</th>
          <th style="width:150px;">Total</th>
          <th style="width:50px;"></th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><input type="text" name="description[]" class="form-control"></td>
          <td><input type="number" name="quantity[]" class="form-control qty" value="1"></td>
          <td><input type="number" name="unit_price[]" class="form-control price" value="0"></td>
          <td><input type="text" name="total[]" class="form-control total" readonly></td>
          <td><button type="button" class="btn btn-danger btn-sm remove-row">X</button></td>
        </tr>
      </tbody>
    </table>
    <button type="button" class="btn btn-sm btn-secondary" id="addRow">+ Add Item</button>

    <!-- Totals -->
    <div class="row mt-4">
      <div class="col-md-6"></div>
      <div class="col-md-6">
        <table class="table">
          <tr>
            <th>Subtotal:</th>
            <td><input type="text" name="subtotal" id="subtotal" class="form-control" readonly></td>
          </tr>
          <tr>
            <th>Tax (%):</th>
            <td><input type="number" name="tax_rate" id="tax_rate" class="form-control" value="18"></td>
          </tr>
          <tr>
            <th>Total:</th>
            <td><input type="text" name="total" id="total" class="form-control" readonly></td>
          </tr>
        </table>
      </div>
    </div>

    <button type="submit" class="btn btn-primary">Save</button>
  </form>
</div>

<script>
  // Dynamic totals
  document.addEventListener("input", function() {
    let subtotal = 0;
    document.querySelectorAll("#itemsTable tbody tr").forEach(row => {
      let qty = parseFloat(row.querySelector(".qty").value) || 0;
      let price = parseFloat(row.querySelector(".price").value) || 0;
      let total = qty * price;
      row.querySelector(".total").value = total.toFixed(2);
      subtotal += total;
    });
    document.getElementById("subtotal").value = subtotal.toFixed(2);
    let taxRate = parseFloat(document.getElementById("tax_rate").value) || 0;
    let total = subtotal + (subtotal * taxRate / 100);
    document.getElementById("total").value = total.toFixed(2);
  });

  // Add/remove rows
  document.getElementById("addRow").addEventListener("click", () => {
    let newRow = document.querySelector("#itemsTable tbody tr").cloneNode(true);
    newRow.querySelectorAll("input").forEach(i => i.value = "");
    document.querySelector("#itemsTable tbody").appendChild(newRow);
  });
  document.addEventListener("click", e => {
    if (e.target.classList.contains("remove-row")) e.target.closest("tr").remove();
  });

  // Dynamic form action
  document.getElementById("document_type").addEventListener("change", function() {
    const form = document.getElementById("documentForm");
    if (this.value === "invoice") {
      form.action = "{% url 'create-invoice' %}";
    } else {
      form.action = "{% url 'add-quotation' %}";
    }
  });
  document.getElementById("document_type").dispatchEvent(new Event("change"));
</script>

{% endblock %}
